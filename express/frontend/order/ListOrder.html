<!doctype html>
<html lang="br">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pedido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.2/dist/purify.min.js"></script>
  <style>
    .produtos-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 400px;
      background-color: white;
      border: 1px solid black;
      padding: 10px;
      display: none;
    }
  </style>
</head>

<body onload="getAllProducts()">
  <button type="button" class="btn btn-danger p-3 m-3" onclick="window.location.href='../options.html'">Voltar</button>
  <div class="container my-5">
    <h1>Lista de Pedidos</h1>
    <a class='btn btn-primary btn-sm' href='createOrder.html'>Novo pedido</a>
    <br>
    <table style="width: 100%; height: 500px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fornecedor</th>
          <th>Data do pedido</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabela-corpo">
        <!-- ConteÃºdo da tabela -->
      </tbody>
    </table>
  </div>
  <div id="produtos-popup" class="produtos-popup">
    <h3>Produtos do Pedido</h3>
    <ul id="lista-produtos"></ul>
    <button onclick="fecharProdutos()">Fechar</button>
    <button type="button" class="btn btn-primary btn-sm" id="gerar-pdf">Gerar PDF</button>
  </div>
  <script>
    document.getElementById("gerar-pdf").addEventListener("click", function () {
      const lista = document.getElementById("lista-produtos");
      const titulo = document.querySelector("#h4Forne");
      
      html2canvas(lista).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        window.jsPDF = window.jspdf.jsPDF;
        const pdf = new jsPDF("p", "pt", "a4");
        pdf.addImage(imgData, 'PNG', 0, 0);
        pdf.save("pedido.pdf");

      });
    });

    function getAllProducts() {

      var config = {
        method: 'get',
        maxBodyLength: Infinity,
        url: 'http://localhost:8080/order',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
      };

      axios(config)
        .then(function (response) {

          const
            data = response.data;

          console.log(data)

          let tableFront = document.querySelector("#tabela-corpo");

          data.forEach(function (order) {
            tableFront.innerHTML += `
          <tr>
            <td>${order.ID_PED}</td>
            <td>${order.NOME_FORNE}</td>
            <td>${order.DAT_PED}</td>
            <td>${order.status}</td>
            <td><a class='btn btn-primary btn-sm' onclick="viewOrder('${order.ID_PED}')"'>Ver pedido</a></td>
            <td><a class='btn btn-danger btn-sm' onclick="deleteOrder('${order.ID_PED}')"'>Inativar</a></td>
            <td><a class='btn btn-danger btn-sm' onclick="enableOrder('${order.ID_PED}')"'>Ativar</a></td>
          </tr>
        `;
          });

        })
        .catch(function (error) {
          console.log(error);
          alert("Algo deu errado.");
        });
    }

    function deleteOrder(orderId) {

      var config = {
        method: 'delete',
        maxBodyLength: Infinity,
        url: `http://localhost:8080/order/${orderId}`,
        headers: {}
      };

      axios(config)
        .then(function (response) {
          alert(JSON.stringify(response.data));
          location.reload()
        })
        .catch(function (error) {
          alert(error);
        });
    }

    function enableOrder(orderId) {

      var config = {
        method: 'post',
        maxBodyLength: Infinity,
        url: `http://localhost:8080/order/${orderId}`,
        headers: {}
      };

      axios(config)
        .then(function (response) {
          alert(JSON.stringify(response.data));
          location.reload()
        })
        .catch(function (error) {
          alert(error);
        });
    }

    function viewOrder(orderId) {

      var listaProdutos = document.querySelector('#lista-produtos');
      var produtosDiv = document.querySelector('#produtos-popup');
      var id = document.createAttribute("id");

      const
        minhaDiv = document.querySelector('#produtos-popup'),
        h4 = document.createElement('h4');

      axios.get(`http://localhost:8080/order/${orderId}/products`)
        .then(function (response) {
          var produtos = response.data;

          listaProdutos.innerHTML = produtos.map(function (produto) {
            return '<li> Produto: '+ produto.DESC_PROD + ' - Quantidade: ' + produto.amount + '</li>';
          }).join('');
          produtosDiv.style.display = "block";
        })
        .catch(function (error) {
          console.log(error);
        });
    }

    function fecharProdutos() {
      var produtosDiv = document.querySelector('#produtos-popup');
      produtosDiv.style.display = "none";
    }
  </script>
</body>

</html>